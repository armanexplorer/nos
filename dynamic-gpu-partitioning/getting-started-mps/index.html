<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Getting started with MPS partitioning - nos</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">nos</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../overview/" class="nav-link">Overview</a>
                            </li>
                            <li class="navitem">
                                <a href="../../prerequisites/" class="nav-link">Prerequisites</a>
                            </li>
                            <li class="navitem">
                                <a href="../../installation/" class="nav-link">Installation</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Dynamic GPU Partitioning <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../overview/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../getting-started-mig/" class="dropdown-item">Getting started with MIG partitioning</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Getting started with MPS partitioning</a>
</li>
                                    
<li>
    <a href="../partitioning-modes-comparison/" class="dropdown-item">Partitioning modes comparison</a>
</li>
                                    
<li>
    <a href="../configuration/" class="dropdown-item">Configuration</a>
</li>
                                    
<li>
    <a href="../troubleshooting/" class="dropdown-item">Troubleshooting</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Elastic Resource Quota <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../elastic-resource-quota/overview/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../elastic-resource-quota/getting-started/" class="dropdown-item">Getting started</a>
</li>
                                    
<li>
    <a href="../../elastic-resource-quota/key-concepts/" class="dropdown-item">Key concepts</a>
</li>
                                    
<li>
    <a href="../../elastic-resource-quota/configuration/" class="dropdown-item">Configuration</a>
</li>
                                    
<li>
    <a href="../../elastic-resource-quota/troubleshooting/" class="dropdown-item">Troubleshooting</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Developer <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../developer/getting-started/" class="dropdown-item">Getting started</a>
</li>
                                    
<li>
    <a href="../../developer/contribution-guidelines/" class="dropdown-item">Contribution guidelines</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Helm Charts <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../helm-charts/nos/" class="dropdown-item">nos</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../telemetry/" class="nav-link">Telemetry</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../getting-started-mig/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../partitioning-modes-comparison/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#getting-started-with-mps-partitioning" class="nav-link">Getting started with MPS partitioning</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#prerequisites" class="nav-link">Prerequisites</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#enable-automatic-partitioning" class="nav-link">Enable automatic partitioning</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#create-pods-requesting-mps-resources" class="nav-link">Create pods requesting MPS resources</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="getting-started-with-mps-partitioning">Getting started with MPS partitioning</h1>
<p>!!! warning
    <a href="https://docs.nvidia.com/deploy/mps/index.html">Multi-Process Service (MPS)</a> is supported only by NVIDIA GPUs based on Volta and newer architectures.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>you need the Nebuly <a href="https://github.com/nebuly-ai/k8s-device-plugin#installation">k8s-device-plugin</a> installed on your cluster</li>
</ul>
<h2 id="enable-automatic-partitioning">Enable automatic partitioning</h2>
<p>You can enable automatic MPS partitioning on a node by adding to it the following label:</p>
<pre><code class="language-shell">kubectl label nodes &lt;node-name&gt; &quot;nos.nebuly.com/gpu-partitioning=mps&quot;
</code></pre>
<p>The label delegates to <code>nos</code> the management of the MPS resources of all the GPUs of that node. You just have to create submit your Pods to the cluster and  the requested MPS resources are automatically provisioned.</p>
<h2 id="create-pods-requesting-mps-resources">Create pods requesting MPS resources</h2>
<p>You can make your pods request slices of GPU by specifying MPS resources in their containers requests. MPS devices are exposed by our k8s-device-plugin using the following naming convention: <code>nvidia.com/gpu-&lt;size&gt;gb</code>, where <code>&lt;size&gt;</code> corresponds to the GB of memory of the GPU slice. The computing resources are instead equally shared among all its MPS resources.</p>
<p>You can specify any size you want, but you should keep in mind that the GPU Partitioner will create an MPS resource on a certain GPU only if its size is smaller or equal than the total amount of memory of that GPU (which is indicated by the node label <code>nvidia.com/gpu.memory</code> applied by the NVIDIA GPU Operator).</p>
<p>For instance, you can create a pod requesting a slice of a 10GB of GPU memory as follows:</p>
<pre><code class="language-yaml">$ kubectl apply -f - &lt;&lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: mps-partitioning-example
spec:
  hostIPC: true # (2)
  securityContext:
    runAsUser: 1000 # (3)
  containers:
    - name: sleepy
      image: &quot;busybox:latest&quot;
      command: [&quot;sleep&quot;, &quot;120&quot;]
      resources:
        limits:
          nvidia.com/gpu-10gb: 1 # (1)
EOF
</code></pre>
<ol>
<li>Fraction of GPU with 10 GB of memory</li>
<li><code>hostIPC</code> must be set to true</li>
<li>Containers must run as the same user as the MPS Server</li>
</ol>
<p>Pods requesting MPS resources must meet two requirements:</p>
<ol>
<li><code>hostIPC</code> must be set to <code>true</code> in order to allow containers to access the IPC namespace of the host</li>
<li>Containers must run as the same user as the user running the MPS server on the host, which is <code>1000</code> by default</li>
</ol>
<p>The two requirements above are due to how MPS works. Since it requires the clients and the server to share the same memory space, we need to allow the pods to access the host IPC namespace so that it can communicate with the MPS server running on it. Moreover, the MPS server accepts only connections from clients running as the same user as the server, which is <code>1000</code> by default (you can change it by setting the <code>mps.userID</code> value when installing the <a href="https://github.com/nebuly-ai/k8s-device-plugin#installation">k8s-device-plugin</a> chart), so the containers of your pods must run with the same user if they request MPS resources.</p>
<p>!!! note
    Containers are supposed to request at most one MPS device. If a container needs more resources,
    then it should ask for a larger, single device as opposed to multiple smaller devices</p>
<p>!!! warning
    If you run <code>nvidia-smi</code> inside a container, the output still shows the whole memory of the GPU.
    Nevertheless, processes inside the container are able to allocate only the amount of memory requested by the contaner.
    You can check the availble GPU memory through the environment variable <code>CUDA_MPS_PINNED_DEVICE_MEM_LIMIT</code>.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
